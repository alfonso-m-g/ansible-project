-
  name: 'Deploy pre-requisites'
  hosts: target2
  tasks:
    - name: 'Install firewalld'
      command: apt-get install -y firewalld

    - name: 'Start firewalld service'
      command: service firewalld start

    - name: 'Enable firewalld service'
      command: systemctl enable firewalld

-
  name: 'DB - Install mysql'
  hosts: target2
  tasks:
    - name: 'Install MySQL'
      command: apt-get install -y mariadb-server
      args:
        warn: false

    - name: 'Start mysql service'
      command: service mariadb start

    - name: 'Enable mysql'
      command: systemctl enable mariadb

    - name: 'Configure firewall'
      command: firewall-cmd --permanent --zone=public --add-port=3306/tcp
      command: firewall-cmd --reload

-
  name: 'DB - Configure database'
  hosts: target2
  tasks:
    - name: 'Install dependencies'
      pip:
        name: pymysql

    - name: 'Create database'
      mysql_db:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        name: ecomdb
        state: present        
    
    - name: 'Create user'
      mysql_user:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        name: ecomuser
        password: ecompassword
        host: localhost
        priv: '*.*:ALL,GRANT'
        state: present
    
    - name: 'Load Product Inventory Information to database'
      ansible.builtin.copy:
        src: ./db-load-script.sql
        dest: /home/ubuntu

    - name: 'Load script'
      shell: mysql < /home/ubuntu/db-load-script.sql
      ignore_errors: yes

-
  name: 'Deploy and configure web'
  hosts: target2
  tasks:
    - name: 'Install required packages'
      command: apt-get install -y apache2 php php-mysql

    - name: 'Configure firewall port 80'
      command: firewall-cmd --permanent --zone=public --add-port=80/tcp
      command: firewall-cmd --reload
  
    - name: 'Add line to /etc/apache2/apache2.conf'
      lineinfile:
        path: /etc/apache2/apache2.conf
        line: ServerName 127.0.0.1
        
    - name: 'Configure apache2'
      command: sed -i 's/index.html/index.php/g' /etc/apache2/apache2.conf

    - name: 'Start apache2'
      service:
        name: apache2
        state: started

    - name: 'Enable apache2'
      command: systemctl enable apache2

    - name: 'Install git'
      apt:
        name: git
        state: present

    - name: 'Empty working directory'
      file:
        path: /var/www/html
        state: absent

    - name: 'Download code'
      git:
        repo: https://github.com/kodekloudhub/learning-app-ecommerce
        dest: /var/www/html/

    - name: 'Update index.php file'
      command: "sed -i 's/172.20.1.101/localhost/g' /var/www/html/index.php"

    - name: 'Install curl'
      apt:
        name: curl
        state: present

    - name: 'Test app'    
      command: curl http://localhost